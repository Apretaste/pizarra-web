<div class="body padding notes">
    <div style="display:none;padding:0px;" id = "search-box">
         <br/>
        <p>Por favor escriba un @username, un #hashtag o un texto a buscar</p>
          <input type="text" class="w-input input-form" id="search-query" style="width:95%;">
    </div>

    <table style="display:none;" id="news-template">
    <?php include "_row.phtml"; ?>
    </table>

    <div class="news-mask"></div>
        <div class="news-container">
        <table id = "list-news" class="w-clearfix list-news">
            <!-- dynamic zone -->

            <?php
                foreach ($notes as $note)
                    echo Helper::parseTpl("feed/_row", [
                            [$profile, "note.profile.", ""],
                            [$note, "note.", ""]
                    ]);
            ?>
        </table>
        <br/><br/><br/><br/>
    </div>
</div>

<div class="w-clearfix input-chat-block shadowed-block">
    <div class="w-form">
        <div class="column-left">
            <div class="image-message notes-avatar"><a class = "show-edit" href="#" data-load="1">
				<img width="50" height="50" src="{{ profile.picture_public }}"></a>
            </div>
        </div>

        <input id="edtNote" class="w-input input-chat input-notes" id="chat-message" type="text" placeholder="Escribe una nueva nota..." name="nota" data-name="Nota">
        <input id="btnSendNote" class="w-button chat-button action-button" type="button" value="Enviar" data-wait="Por favor espere...">
    </div>
</div>

<script type="text/javascript">
$(function(){
    $(".show-edit").click(function(){
        pizarra.pages.edit.show(pizarra.getCurrentProfile(false));
    });

    $(".show-chats").click(function(){
        pizarra.pages.chats.show();
    });

    $(".show-search-box").click(function(){
        $("#search-box").dialog({
            title: "Buscar en Pizarra",
            modal: true,
            buttons: [
                {
                    text: "Buscar",
                    click: function() {
                        var query = $("#search-query").val();
                        query = trim(query);
                        if (query != '')
                        {
                            var token = pizarra.getToken();
                            if(token != null) {
                                var notes = pizarra.run('PIZARRA BUSCAR ' + query, null,null, false);
                                if (strtoupper(notes.code) == 'OK')
                                    if (!isset(notes.notes)) {
                                        $("#search-box").notify(wordwrap(html_entity_decode(notes.text),20,'\n',false));
                                    } else {
                                        pizarra.lastSearchResults = notes;
                                        var q = $("#search-query").val();
                                        $( this ).dialog( "close" );
                                        pizarra.pages.search.show({query: q});
                                    }
                            }
                        }
                    }
                },
                {
                    text: "Cerrar",
                    click: function(){
                        $(this).dialog('close');
                    }
                }

            ]
        });
    });

    $(".show-search").click(function(){
        var token = pizarra.getToken();
        if(token != null) {
            var notes = pizarra.run('PIZARRA BUSCAR ' + $("#search-query").val(), null,null, false);
            if (strtoupper(notes.code) == 'OK')
                if (!isset(notes.notes)) {
                    $("#search-query").notify(wordwrap(html_entity_decode(notes.text),20,'\n',false));
                } else {
                    pizarra.lastSearchResults = notes;
                    var q = $("#search-query").val();
                    pizarra.pages.search.show({query: q});
                }
        }
    });

    $("#edtNote").on('keydown', function(e)
    {
        if (e.keyCode == 13)
            sendNote();
    });

    $("#btnSendNote").click(function(){
        sendNote();
    });

    $('body').keypress(function(a){
        if (a.keyCode == 27)
        {
            $("#search-box").hide();
            $(".top-buttons").show();
        }
    });

    $("#btnCloseSearchBox").click(function(){
        $("#search-box").hide();
        $(".top-buttons").show();
    });

    $.notify.addStyle('happyblue', {
        html: "<div><span data-notify-text/></div>",
        position: "top",
        classes: {
            base: {
                "white-space": "nowrap",
                "background-color": "lightblue",
                "padding": "5px"
            },
            superblue: {
                "color": "white",
                "background-color": "blue"
            }
        }
    });

    refreshNotes(true);
});

function refreshNotes(showLoading)
{
    if (!isset(showLoading))
        showLoading = true;

    var timeout = 120000;
    var token = pizarra.getToken();
    var htmlNotes = '';
    if(token != null)
    {
        var notes = pizarra.action("/feed").payload.notes;
        var tpl = $("#news-template").html();

        for(var item in notes)
        {
            var html = tpl;
            var profile = notes[item].profile;

            if (profile.picture != '1')
                profile.picture_public = "images/user.png";

            notes[item].followcolor = 'black';
            if (notes[item].friend == true)
                notes[item].followcolor = 'red';

            notes[item].text = notes[item].text.linkify();

            html = pizarra.replaceTags(html, profile, 'note.profile.');
            html = pizarra.replaceTags(html, notes[item], '');

            htmlNotes += html;
        }

        $("#list-news").html(htmlNotes);

        $("a").each(function(){
            var href = $(this).attr('href');

            if (strpos(href,'mailto:') !== false)
            {
                $(this).attr('href',"#");
                var username = substr($(this).html(),1);
                $(this).attr('onclick', "pizarra.pages.profile.show(pizarra.getProfile('" + username + "'));");
            }

        });
    }

    setTimeout("refreshNotes(false);", timeout);
}

function sendNote(){
    var result = pizarra.submit('publish/' + urlencode($("#edtNote").val()));
    refreshNotes();
    $("#edtNote").val('');
}

</script>